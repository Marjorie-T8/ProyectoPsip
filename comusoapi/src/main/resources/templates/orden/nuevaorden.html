<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{plantilla/plantillaui}">
<body>
<div layout:fragment="contenidopaginas">
    <div class="container-fluid">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="card-title text-primary">GENERAR ÓRDEN DE TRABAJO - ICPE S.A.S.</h4>
                <hr>

                <form th:action="@{/orden/nueva}" method="get" id="formFiltro" class="mb-4">
                    <div class="row">
                        <div class="col-md-12">
                            <label class="form-label fw-bold text-primary">1. Busque el Cliente por Cédula</label>
                            
                            <div class="alert alert-warning py-2 mb-2" style="font-size: 0.85rem;">
                                <i class="mdi mdi-information-outline"></i> 
                                <strong>Nota:</strong> Ingrese el número de cédula y selecciónelo de la lista. El nombre aparecerá automáticamente abajo.
                            </div>
                            
                            <input list="clientesList" id="clienteInput" class="form-control border-primary" 
                                   placeholder="Escriba la cédula aquí..."
                                   th:value="${clienteInfo != null ? clienteInfo.cedula : ''}"
                                   autocomplete="off">
                            
                            <datalist id="clientesList">
                                <option th:each="c : ${listaclientes}" 
                                        th:data-id="${c.idCliente}"
                                        th:value="${c.cedula}"
                                        th:label="${c.nombre}"> </option>
                            </datalist>

                            <input type="hidden" name="idCliente" id="idClienteHidden" th:value="${idClienteSeleccionado}">
                        </div>
                    </div>
                </form>

                <form th:action="@{/orden/guardar}" th:object="${ordenDTO}" method="post" 
                      th:if="${idClienteSeleccionado != null and idClienteSeleccionado > 0}" id="formOrden">
                    
                    <div class="alert alert-info border-info mb-4" th:if="${clienteInfo != null}">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <strong>Cédula/RUC: </strong> <span th:text="${clienteInfo.cedula}"></span>
                            </div>
                            <div class="col-md-6 border-start">
                                <strong>Cliente Seleccionado: </strong> <span th:text="${clienteInfo.nombre}"></span>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" th:field="*{idCliente}" />
                    <input type="hidden" th:field="*{estado}" />
                    <input type="hidden" th:field="*{fechaSolicitud}" />
                    <input type="hidden" name="activo" value="true" />
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">2. Equipo a Intervenir</label>
                            <select th:field="*{idEquipo}" class="form-select border-primary" required>
                                <option value="0">-- Seleccione Equipo --</option>
                                <option th:each="e : ${listaequipos}" 
                                        th:value="${e.idEquipo}" 
                                        th:text="${e.marca + ' ' + e.modelo}"></option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">3. Técnico Asignado</label>
                            <select th:field="*{idTecnico}" class="form-select" id="comboTecnico" required>
                                <option value="0">-- Seleccione Técnico --</option> 
                                <option th:each="t : ${listatecnicos}" 
                                        th:value="${t.idTecnico}" 
                                        th:text="${t.nombre}"></option> 
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">4. Tipo de Servicio</label>
                            <select th:field="*{idTipoServicio}" class="form-select" id="comboServicio" required>
                                <option value="0">-- Seleccione Servicio --</option> 
                                <option th:each="s : ${listaservicios}" 
                                        th:value="${s.idTipo}" 
                                        th:text="${s.nombre}"></option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha de la Cita</label>
                            <input type="date" th:field="*{fechaCita}" class="form-control" id="fechaCita" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Hora de la Cita</label>
                            <input type="time" th:field="*{horaCita}" class="form-control" id="horaCita" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Descripción del Requerimiento</label>
                        <textarea th:field="*{descripcionTrabajo}" class="form-control" rows="3" 
                                  placeholder="Detalle el problema..." required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Observaciones Adicionales</label>
                        <textarea th:field="*{observaciones}" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="border-top pt-3 text-end">
                        <a th:href="@{/orden/listar}" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="mdi mdi-content-save"></i> Crear Orden
                        </button>
                    </div>
                </form>
                
                <div th:unless="${idClienteSeleccionado != null and idClienteSeleccionado > 0}" class="text-center py-5">
                    <i class="mdi mdi-account-search mdi-48px text-muted"></i>
                    <p class="text-muted">Seleccione un cliente por su cédula para continuar.</p>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const clienteInput = document.getElementById('clienteInput');
        const clientesList = document.getElementById('clientesList');
        const idClienteHidden = document.getElementById('idClienteHidden');
        const formFiltro = document.getElementById('formFiltro');
        
        const fechaInput = document.getElementById('fechaCita');
        const horaInput = document.getElementById('horaCita');

        // --- 1. LÓGICA DEL BUSCADOR POR CÉDULA ---
        clienteInput.addEventListener('input', function() {
            const selectedValue = this.value;
            const options = clientesList.options;
            
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === selectedValue) {
                    const idReal = options[i].getAttribute('data-id');
                    idClienteHidden.value = idReal;
                    formFiltro.submit(); 
                    break;
                }
            }
        });

        // --- 2. VALIDACIÓN DE FECHA Y HORA ACTUAL/FUTURA ---
        const hoy = new Date();
        const yyyy = hoy.getFullYear();
        const mm = String(hoy.getMonth() + 1).padStart(2, '0');
        const dd = String(hoy.getDate()).padStart(2, '0');
        const fechaHoyString = `${yyyy}-${mm}-${dd}`;

        if(fechaInput) {
            // Bloquea visualmente días pasados en el calendario
            fechaInput.setAttribute("min", fechaHoyString);

            const validarTiempo = () => {
                const fechaSeleccionada = fechaInput.value;
                const horaSeleccionada = horaInput.value;

                if (fechaSeleccionada === fechaHoyString && horaSeleccionada) {
                    // Si es hoy, comparamos horas y minutos
                    const [horasSel, minutosSel] = horaSeleccionada.split(':');
                    const tiempoSeleccionado = new Date();
                    tiempoSeleccionado.setHours(parseInt(horasSel), parseInt(minutosSel), 0);

                    if (tiempoSeleccionado < hoy) {
                        alert("No puede seleccionar una hora que ya pasó para el día de hoy.");
                        horaInput.value = ""; // Resetea la hora
                    }
                }
            };

            fechaInput.addEventListener('change', validarTiempo);
            horaInput.addEventListener('change', validarTiempo);
        }
    });
    </script>
</div>
</body>
</html>